#!/bin/bash
set -eux


REASON=${1:-""}
LOCK=`head -c100 /dev/urandom | tr -dc A-Za-z0-9 | head -c 8`

virtualenv .env
set +u
. .env/bin/activate
set -u

pip install -I http://core.xenrt.citrite.net/xenrtapi.tar.gz

machine_entry=`xenrt mlist -s SJCLAB01 -o OPENSTACK -R "memory>12G/disk1>=120G" -n | tail -n+3 | shuf -n1`
machine_name=${machine_entry%% *}
xenrt borrow $machine_name -f -r "(LOCK=$LOCK) $REASON"

echo "HOST=${machine_name}.xenrt.xs.citrite.net"
echo "LOCK=$LOCK"
