#!/bin/bash
set -eux

REASON=${1:-""}
LOCK=`head -c100 /dev/urandom | tr -dc A-Za-z0-9 | head -c 8`

# Redirect stdout for these commands
exec 3>&1
exec 1>&2

[ -e .env ] || virtualenv .env
set +u
. .env/bin/activate
set -u

if [ ! -e `which xenrt` ]; then
  pip install requests
  pip install -I http://core.xenrt.citrite.net/xenrtapi.tar.gz
fi

exec 1>&3
exec 3>&-

machine_entry=`xenrt mlist -s SJCLAB01 -o OPENSTACK -R "memory>12G/disk1>=120G" -n | tail -n+3 | shuf -n1`
machine_name=${machine_entry%% *}
xenrt borrow $machine_name -f -r "(LOCK=$LOCK) $REASON"

# Get stdout back
exec 1>&3
exec 3>&-

echo "HOST=${machine_name}.xenrt.xs.citrite.net"
echo "LOCK=$LOCK"
